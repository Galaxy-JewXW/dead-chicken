# 树木系统使用说明

## 🎯 系统概述

树木系统是一个与电力线系统完全集成的环境美化模块，可以在建立电塔和电线的同时自动在场景中放置树木，让电力线巡检场景更加自然和真实。

## ✨ 主要特性

### 🚀 自动集成
- **无缝集成**: 与PowerlineExtractionSceneBuilder完全集成
- **自动触发**: 在建立电力线时自动放置树木
- **智能清理**: 场景重建时自动清理旧树木

### 🌳 智能放置
- **基于CSV数据**: 从trees.csv文件加载精确的树木位置
- **电塔关联**: 每个树木都与特定电塔关联
- **随机补充**: 在电塔附近自动添加随机树木

### 🎨 视觉效果
- **随机旋转**: 每棵树都有随机的旋转角度
- **随机缩放**: 支持0.8-1.2倍的随机缩放
- **自动高度**: 自动调整树木高度以贴合地形

## 📋 系统要求

### 必需组件
- `PowerlineExtractionSceneBuilder` - 电力线场景构建器
- `Tree.prefab` - 树木预制体（位于Resources/Prefabs/目录）
- `trees.csv` - 树木数据文件（位于Resources/目录）
- `TerrainManager` - 地形管理器（可选，用于地形适配）

### 推荐配置
- Unity 2022.3 LTS 或更高版本
- 8GB+ RAM
- 支持DirectX 11/12的显卡

## 🛠️ 安装和配置

### 1. 准备树木预制体
确保`Tree.prefab`位于`Assets/Resources/Prefabs/`目录中：
```
Assets/
└── Resources/
    └── Prefabs/
        └── Tree.prefab
```

### 2. 准备树木数据
将`trees.csv`文件放在`Assets/Resources/`目录中：
```
Assets/
└── Resources/
    └── trees.csv
```

### 3. 配置PowerlineExtractionSceneBuilder
在场景中找到`PowerlineExtractionSceneBuilder`组件，配置以下参数：

#### 基础配置
```csharp
[Header("树木配置")]
public bool enableTreePlacement = true;           // 启用树木放置
public GameObject treePrefab;                     // 树木预制体（可选，会自动加载）
public string treeCsvFileName = "trees";          // 树木CSV文件名
```

#### 放置配置
```csharp
public int treesPerTower = 3;                     // 每个电塔附近的树木数量
public float minTreeDistanceFromTower = 8f;       // 树木距离电塔的最小距离
public float maxTreeDistanceFromTower = 25f;      // 树木距离电塔的最大距离
```

#### 视觉效果配置
```csharp
public bool enableTreeAutoScaling = true;         // 启用树木自动缩放
public Vector2 treeHeightRange = new Vector2(3f, 8f); // 树木目标高度范围
```

## 📊 数据格式

### trees.csv格式
```csv
tree_id,group_id,tower_id,x,y,z,tree_type
0,0,0,295.5,335.0,4.9,Tree
1,0,0,292.0,338.0,4.8,Tree
2,0,0,296.0,334.0,4.9,Tree
3,0,1,290.0,325.0,7.7,Tree
4,0,1,293.0,329.0,7.6,Tree
```

### 字段说明
- **tree_id**: 树木唯一标识符（整数）
- **group_id**: 所属组ID，与电力线分组对应（整数）
- **tower_id**: 关联的电塔ID（整数）
- **x, y, z**: 树木的3D坐标（浮点数）
- **tree_type**: 树木类型（字符串，默认为"Tree"）

### 坐标系统
- **输入坐标**: CSV中的x,y,z
- **Unity坐标**: x→X, y→Z, z→Y（高度）
- **自动偏移**: 系统会自动添加±2米的随机偏移避免重叠

## 🎮 使用方法

### 自动模式（推荐）
1. 确保`enableTreePlacement = true`
2. 运行电力线提取流程
3. 系统会自动在建立电塔和电线后放置树木

### 手动控制
```csharp
// 获取PowerlineExtractionSceneBuilder引用
var builder = FindObjectOfType<PowerlineExtractionSceneBuilder>();

// 重新加载树木
builder.ReloadTrees();

// 清除所有树木
builder.ClearAllTrees();
```

### 运行时配置
```csharp
// 动态调整树木数量
builder.treesPerTower = 5;

// 调整距离范围
builder.minTreeDistanceFromTower = 10f;
builder.maxTreeDistanceFromTower = 30f;

// 重新应用配置
builder.ReloadTrees();
```

## 🔧 高级功能

### 地形适配
如果场景中有`TerrainManager`，树木会自动调整高度以贴合地形：
```csharp
// 地形高度查询
float terrainHeight = terrainManager.GetTerrainHeight(x, z);
treePosition.y = Mathf.Max(treePosition.y, terrainHeight);
```

### 性能优化
- **最大数量限制**: 通过`maxTrees`参数控制
- **LOD支持**: 启用`useLOD`选项
- **遮挡剔除**: 启用`enableOcclusionCulling`选项

### 自定义树木类型
可以扩展系统支持不同类型的树木：
```csharp
// 在TreeData中添加新字段
public string treeType;
public float treeScale;
public Material treeMaterial;
```

## 🐛 故障排除

### 常见问题

#### Q: 树木不显示？
**A: 检查以下几点**：
1. 确认`enableTreePlacement = true`
2. 检查`trees.csv`文件是否存在且格式正确
3. 确认`Tree.prefab`在正确位置
4. 查看Console中的错误信息

#### Q: 树木位置不正确？
**A: 可能的原因**：
1. CSV坐标格式错误
2. 坐标转换问题
3. 地形适配失败

#### Q: 性能问题？
**A: 优化建议**：
1. 减少`treesPerTower`数量
2. 启用LOD系统
3. 调整`maxTreeDistanceFromTower`参数
4. 使用更简单的树木模型

### 调试工具
```csharp
// 启用Gizmos查看树木位置
// 在Scene视图中选择PowerlineExtractionSceneBuilder对象

// 查看统计信息
Debug.Log(builder.GetStatistics());

// 手动测试树木放置
builder.ReloadTrees();
```

## 📈 性能优化

### 内存管理
- 合理设置最大树木数量
- 定期清理不需要的树木
- 使用对象池管理树木实例

### 渲染优化
- 启用LOD系统
- 使用遮挡剔除
- 优化树木模型的复杂度

### 计算优化
- 限制树木搜索范围
- 使用空间分区算法
- 异步加载树木数据

## 🔮 未来扩展

### 计划功能
- [ ] 支持多种树木类型
- [ ] 动态季节变化
- [ ] 风力效果模拟
- [ ] 树木生长动画
- [ ] 批量树木编辑工具

### 自定义扩展
系统设计为可扩展架构，支持：
- 自定义树木生成算法
- 第三方树木模型集成
- 环境参数动态调整
- 多平台导出支持

## 📚 相关文档

- [电力线可视化系统技术文档](电力线可视化系统技术文档.md)
- [PowerlineExtractionSceneBuilder API](Scripts/PointCloud/PowerlineExtractionSceneBuilder.cs)
- [TreeManager API](Scripts/Components/TreeManager.cs)
- [EnhancedTreeManager API](Scripts/Components/EnhancedTreeManager.cs)

## 🤝 技术支持

如有问题或建议，请：
1. 查看Console错误信息
2. 检查配置参数
3. 参考故障排除部分
4. 提交Issue到项目仓库

---

**树木系统** - 让电力线巡检场景更加自然！ 🌳⚡
